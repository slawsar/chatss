<!DOCTYPE html>
<html lang="pl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat SS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Niestandardowy pasek przewijania */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Animacja dla wiadomości */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animation {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Styl dla przeciągnij i upuść */
        .drag-over {
            border: 2px dashed #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
/* Style dla zakładek */
.chat-tab {
    position: relative;
    transition: all 0.2s;
}

.chat-tab:hover .tab-close {
    display: flex;
}

.tab-close {
    display: none;
    position: absolute;
    top: 2px;
    right: 2px;
    height: 16px;
    width: 16px;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    background-color: rgba(107, 114, 128, 0.2);
    color: rgba(75, 85, 99);
}

.dark .tab-close {
    background-color: rgba(55, 65, 81, 0.5);
    color: rgba(209, 213, 219);
}

.tab-close:hover {
    background-color: rgba(239, 68, 68, 0.9);
    color: white;
}
        /* Dodatkowe style dla lepszego wyglądu na urządzeniach mobilnych */
@media (max-width: 640px) {
    .mobile-bottom-padding {
        padding-bottom: 80px;
    }
    
    .chat-tabs-container {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 4px;
    }
}
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div id="app" class="h-full flex flex-col">
        <!-- Nagłówek/Nawigacja -->
        <header class="bg-white dark:bg-gray-800 shadow-sm z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <!-- Logo i przycisk menu mobilnego -->
                    <div class="flex items-center">
                        <button id="mobile-menu-button" class="md:hidden text-gray-500 dark:text-gray-400 mr-2">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <div class="flex items-center">
                            <i class="fas fa-robot text-primary-500 text-2xl mr-2"></i>
                            <span class="text-xl font-bold text-gray-800 dark:text-white">Chat SS</span>
                        </div>
                    </div>

                    <!-- Nawigacja mobilna -->
                    <div class="flex md:hidden">
                        <button id="mobile-settings-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="mobile-toggle-theme" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 ml-1">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                    </div>

                    <!-- Nawigacja desktopowa -->
                    <nav class="hidden md:flex items-center space-x-4">
                        <button id="toggle-theme" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                        <button id="settings-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="compare-button" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 hidden">
                            <i class="fas fa-exchange-alt mr-2"></i>Porównaj modele
                        </button>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Główny obszar zawartości -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Pasek boczny (ukryty na urządzeniach mobilnych) -->
            <aside id="sidebar" class="hidden md:block w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto">
                <div class="p-4">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Dostępne modele</h2>
                    
                    <!-- Kontrolki sortowania modeli -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sortuj według:</label>
                        <select id="sort-models" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                            <option value="name-asc">Nazwa (A-Z)</option>
                            <option value="name-desc">Nazwa (Z-A)</option>
                            <option value="price-asc">Cena (od najniższej)</option>
                            <option value="price-desc">Cena (od najwyższej)</option>
                            <option value="free-first">Darmowe najpierw</option>
                        </select>
                    </div>
                    
                    <!-- Filtrowanie modeli -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filtruj:</label>
                        <div class="flex space-x-2 mb-2">
                            <button id="filter-all" class="px-2 py-1 text-xs bg-primary-500 text-white rounded-md">Wszystkie</button>
                            <button id="filter-free" class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-md">Darmowe</button>
                        </div>
                        <div class="flex space-x-2">
                            <button id="filter-openai" class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-md">OpenAI</button>
                            <button id="filter-anthropic" class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-md">Anthropic</button>
                            <button id="filter-meta" class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-md">Meta</button>
                        </div>
                    </div>
                    
                    <!-- Wyszukiwanie modeli -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Szukaj:</label>
                        <input type="text" id="model-search" placeholder="Szukaj modeli..." class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                    </div>
                    
                    <!-- Lista modeli -->
                    <div id="model-list" class="space-y-2">
                        <!-- Modele będą wypełnione przez JavaScript -->
                        <div class="flex justify-center py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"></div>
                            <span class="ml-2">Ładowanie modeli...</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Nakładka paska bocznego na urządzeniach mobilnych -->
            <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

            <!-- Główny obszar czatu -->
            <main class="flex-1 flex flex-col overflow-hidden">
<!-- Nagłówek czatu z wybranymi modelami -->
<div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
    <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Czat</h2>
        <div class="flex items-center space-x-2">
            <button id="clear-chat" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-trash-alt mr-1"></i> Wyczyść czat
            </button>
        </div>
    </div>
    <div id="selected-models" class="flex flex-wrap gap-2 mt-2">
        <!-- Wybrane modele pojawią się tutaj -->
    </div>
</div>

<!-- Zakładki czatu -->
<div class="chat-tabs-container bg-gray-100 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 py-2 px-4 flex items-center overflow-x-auto">
    <div id="chat-tabs" class="flex space-x-2 flex-grow">
        <!-- Zakładki czatu będą tutaj dodawane -->
    </div>
    <button id="new-chat" class="flex items-center justify-center ml-2 px-3 py-1 rounded-md bg-primary-500 hover:bg-primary-600 text-white">
        <i class="fas fa-plus mr-1"></i> Nowy czat
    </button>
</div>

<!-- Wiadomości czatu -->
<div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 mobile-bottom-padding">
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i class="fas fa-comments text-4xl mb-2"></i>
                        <p>Rozpocznij rozmowę z wybranymi modelami AI</p>
                    </div>
                </div>

                <!-- Pole wprowadzania wiadomości -->
                <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
                    <form id="message-form" class="flex space-x-2">
                        <div class="flex-1 relative">
                            <textarea id="message-input" rows="1" placeholder="Wpisz swoją wiadomość..." class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 resize-none pr-10" style="min-height: 44px;"></textarea>
                            <button type="button" id="send-button" class="absolute right-2 bottom-2 text-primary-500 hover:text-primary-600">
                                <i class="fas fa-paper-plane text-xl"></i>
                            </button>
                        </div>
                    </form>
<div class="flex justify-between items-center mt-2 text-xs text-gray-500 dark:text-gray-400">
    <div>
        <span id="character-count">0</span>/1000
    </div>
</div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Ustawień -->
    <div id="settings-modal" class="fixed inset-0 z-30 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Ustawienia</h3>
                    
                    <div class="space-y-4">
                        <!-- Sekcja klucza API -->
                        <div>
                            <label for="api-key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Klucz API OpenRouter</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <input type="password" id="api-key" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 pr-10" placeholder="sk-or-xxxxxxxxxxxxxxxx">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <button type="button" id="toggle-api-key" class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Twój klucz API jest przechowywany lokalnie w przeglądarce.</p>
                            <div class="mt-2">
                                <button id="save-api-key" class="px-3 py-1 bg-primary-500 text-white text-sm rounded-md hover:bg-primary-600">
                                    Zapisz klucz API
                                </button>
                                <button id="validate-api-key" class="ml-2 px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    Weryfikuj klucz
                                </button>
                            </div>
                        </div>

                        <!-- Wybór motywu -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Motyw</label>
                            <div class="mt-1 flex space-x-4">
                                <button id="light-theme" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-sun mr-1"></i> Jasny
                                </button>
                                <button id="dark-theme" class="px-3 py-2 bg-gray-800 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-moon mr-1"></i> Ciemny
                                </button>
                                <button id="system-theme" class="px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-desktop mr-1"></i> Systemowy
                                </button>
                            </div>
                        </div>

                        <!-- Historia czatu -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Historia czatu</label>
                            <div class="mt-1 flex space-x-2">
                                <button id="export-chats" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    <i class="fas fa-download mr-1"></i> Eksportuj
                                </button>
                                <button id="import-chats" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    <i class="fas fa-upload mr-1"></i> Importuj
                                </button>
                                <input type="file" id="chat-import-file" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-settings" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-500 text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Zamknij
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal porównywania -->
    <div id="compare-modal" class="fixed inset-0 z-30 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Porównaj odpowiedzi modeli</h3>
                    
                    <div id="compare-results" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Tutaj pojawią się wyniki porównania -->
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-compare" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-500 text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Zamknij
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal informacji o modelu -->
    <div id="model-info-modal" class="fixed inset-0 z-30 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="model-info-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Informacje o modelu</h3>
                        <button id="close-model-info" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div id="model-info-content" class="space-y-4">
                        <!-- Tutaj pojawią się informacje o modelu -->
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex">
                    <button id="select-model-from-info" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-500 text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm">
                        Wybierz model
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nakładka ładowania -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                <span class="ml-3 text-lg text-gray-800 dark:text-white">Przetwarzanie żądania...</span>
            </div>
        </div>
    </div>

    <script>
        // Główny stan aplikacji
const state = {
    apiKey: localStorage.getItem('openRouterApiKey') || '',
        chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
    currentChatId: localStorage.getItem('currentChatId') || null,
    theme: localStorage.getItem('theme') || 'system',
    models: [],
    currentInfoModel: null,
    activeFilter: 'all',
    chatTabs: JSON.parse(localStorage.getItem('chatTabs')) || [],
};

        // Elementy DOM
        const elements = {
            app: document.getElementById('app'),
            mobileMenuButton: document.getElementById('mobile-menu-button'),
            mobileSettingsButton: document.getElementById('mobile-settings-button'),
            mobileToggleTheme: document.getElementById('mobile-toggle-theme'),
            sidebar: document.getElementById('sidebar'),
            mobileSidebarOverlay: document.getElementById('mobile-sidebar-overlay'),
            modelList: document.getElementById('model-list'),
            selectedModelsContainer: document.getElementById('selected-models'),
            chatMessages: document.getElementById('chat-messages'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            characterCount: document.getElementById('character-count'),
            clearChat: document.getElementById('clear-chat'),
            newChat: document.getElementById('new-chat'),
            settingsButton: document.getElementById('settings-button'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettings: document.getElementById('close-settings'),
            apiKeyInput: document.getElementById('api-key'),
            toggleApiKey: document.getElementById('toggle-api-key'),
            saveApiKey: document.getElementById('save-api-key'),
            validateApiKey: document.getElementById('validate-api-key'),
            lightTheme: document.getElementById('light-theme'),
            darkTheme: document.getElementById('dark-theme'),
            systemTheme: document.getElementById('system-theme'),
            toggleTheme: document.getElementById('toggle-theme'),
            exportChats: document.getElementById('export-chats'),
            importChats: document.getElementById('import-chats'),
            chatImportFile: document.getElementById('chat-import-file'),
            compareButton: document.getElementById('compare-button'),
            compareModal: document.getElementById('compare-modal'),
            closeCompare: document.getElementById('close-compare'),
            compareResults: document.getElementById('compare-results'),
            modelInfoModal: document.getElementById('model-info-modal'),
            modelInfoTitle: document.getElementById('model-info-title'),
            modelInfoContent: document.getElementById('model-info-content'),
            closeModelInfo: document.getElementById('close-model-info'),
            selectModelFromInfo: document.getElementById('select-model-from-info'),
            sortModels: document.getElementById('sort-models'),
            modelSearch: document.getElementById('model-search'),
            loadingOverlay: document.getElementById('loading-overlay'),
            filterAll: document.getElementById('filter-all'),
            filterFree: document.getElementById('filter-free'),
            filterOpenAI: document.getElementById('filter-openai'),
            filterAnthropic: document.getElementById('filter-anthropic'),
			 chatTabs: document.getElementById('chat-tabs'), 
            filterMeta: document.getElementById('filter-meta')
        };

        // Inicjalizacja aplikacji
        async function init() {
            // Konfiguracja nasłuchiwaczy zdarzeń
            setupEventListeners();
            
            // Zastosowanie zapisanego motywu
            applyTheme(state.theme);
            
            // Wypełnienie pola API key
            if (state.apiKey) {
                elements.apiKeyInput.value = state.apiKey;
            }
            
            // Pobieranie modeli z OpenRouter API
            await fetchModels();
            
            // Renderowanie wybranych modeli
            renderSelectedModels();
            
// Inicjalizacja zakładek lub utworzenie nowej zakładki jeżeli brak
if (state.chatTabs.length === 0) {
    createNewChat();
} else {
    // Załaduj zakładki i przejdź do ostatnio używanej
    renderChatTabs();
    
    if (state.currentChatId && state.chatHistory[state.currentChatId]) {
        activateTab(state.currentChatId);
    } else if (state.chatTabs.length > 0) {
        activateTab(state.chatTabs[0].id);
    } else {
        createNewChat();
    }
}
            // Pokazanie przycisku porównania jeżeli wybrano wiele modeli
            toggleCompareButton();
        }
// Funkcja do migracji starszych danych
function migrateOldData() {
    // Sprawdź czy istnieją globalne wybraneModele z poprzedniej wersji
    const oldSelectedModels = JSON.parse(localStorage.getItem('selectedModels'));
    
    // Migracja danych dla istniejących zakładek
    state.chatTabs.forEach(tab => {
        if (!tab.selectedModels) {
            // Jeśli zakładka nie ma własnej listy wybranych modeli, użyj globalnej
            tab.selectedModels = oldSelectedModels || [];
        }
    });
    
    // Zapisz zaktualizowane zakładki
    saveChatTabs();
    
    // Usuń przestarzałe dane
    if (oldSelectedModels) {
        localStorage.removeItem('selectedModels');
    }
}
        // Funkcja pobierająca modele z OpenRouter API
        async function fetchModels() {
            try {
                let models = [];
                
                if (state.apiKey) {
                    // Próba pobrania modeli z API
                    try {
                        const response = await fetch('https://openrouter.ai/api/v1/models', {
                            headers: {
                                'Authorization': `Bearer ${state.apiKey}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            models = data.data.map(model => {
                                // Wyodrębnij organizację/autora z ID
                                const idParts = model.id.split('/');
                                const organization = idParts[0];
                                
                                return {
                                    id: model.id,
                                    name: model.name,
                                    description: model.description || 'Brak opisu',
                                    pricing: model.pricing || { prompt: '0', completion: '0' },
                                    context_length: model.context_length || 4096,
                                    architecture: model.architecture || {},
                                    free: (parseFloat(model.pricing?.prompt) === 0 && parseFloat(model.pricing?.completion) === 0),
                                    organization: organization
                                };
                            });
                            
                            console.log(`Pobrano ${models.length} modeli z API OpenRouter`);
                        } else {
                            throw new Error('Nie udało się pobrać modeli z API');
                        }
                    } catch (error) {
                        console.error('Błąd podczas pobierania modeli:', error);
                        // Fallback do domyślnych modeli
                        useDefaultModels();
                    }
                } else {
                    // Brak klucza API, użyj domyślnych modeli
                    useDefaultModels();
                }
                
                // Zapisz pobrane modele
                state.models = models;
                
                // Renderuj listę modeli
                renderModels();
            } catch (error) {
                console.error('Błąd podczas inicjalizacji modeli:', error);
                elements.modelList.innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <i class="fas fa-exclamation-circle mb-2"></i>
                        <p>Błąd podczas ładowania modeli</p>
                    </div>
                `;
            }
        }

        // Funkcja ustawiająca domyślne modele
        function useDefaultModels() {
            state.models = [
                {
                    id: 'openai/gpt-3.5-turbo',
                    name: 'GPT-3.5 Turbo',
                    description: 'Szybki i wydajny model od OpenAI. Dobry do codziennych zastosowań, obsługi klienta i prostych zadań generacyjnych. Oferuje dobry balans między ceną a wydajnością.',
                    pricing: { prompt: '0.0000015', completion: '0.000002' },
                    context_length: 4096,
                    architecture: {
                        input_modalities: ['text'],
                        output_modalities: ['text']
                    },
                    free: false,
                    organization: 'openai'
                },
                {
                    id: 'openai/gpt-4o',
                    name: 'GPT-4o',
                    description: 'Najbardziej zaawansowany model od OpenAI. Wykazuje się zaawansowanym rozumowaniem, wiedzą specjalistyczną i umiejętnościami rozwiązywania problemów. Idealny do złożonych zadań i aplikacji wymagających wysokiej dokładności.',
                    pricing: { prompt: '0.00003', completion: '0.00006' },
                    context_length: 128000,
                    architecture: {
                        input_modalities: ['text', 'image'],
                        output_modalities: ['text']
                    },
                    free: false,
                    organization: 'openai'
                },
                {
                    id: 'anthropic/claude-3.5-sonnet',
                    name: 'Claude 3.5 Sonnet',
                    description: 'Najnowszy model od Anthropic. Wyróżnia się zdolnością do prowadzenia przyjaznych i naturalnych konwersacji, przy zachowaniu wysokiej jakości odpowiedzi merytorycznych. Doskonały do długich kontekstów i skomplikowanych tematów.',
                    pricing: { prompt: '0.00001102', completion: '0.00003268' },
                    context_length: 200000,
                    architecture: {
                        input_modalities: ['text', 'image'],
                        output_modalities: ['text']
                    },
                    free: false,
                    organization: 'anthropic'
                },
                {
                    id: 'google/gemini-pro',
                    name: 'Gemini Pro',
                    description: 'Zaawansowany model od Google. Cechuje się nowoczesną architekturą i wysoką wydajnością przy zachowaniu przystępnej ceny. Dobry do zadań analitycznych i pracy z danymi.',
                    pricing: { prompt: '0.0000005', completion: '0.0000005' },
                    context_length: 32768,
                    architecture: {
                        input_modalities: ['text'],
                        output_modalities: ['text']
                    },
                    free: false,
                    organization: 'google'
                },
                {
                    id: 'meta-llama/llama-3.1-70b-instruct',
                    name: 'Llama 3.1 70B',
                    description: 'Duży model od Meta o otwartej architekturze. Zapewnia wysoką jakość odpowiedzi przy relatywnie niskich kosztach. Dobrze radzi sobie z zadaniami wymagającymi rozumowania i generowania tekstu.',
                    pricing: { prompt: '0.0000007', completion: '0.0000009' },
                    context_length: 128000,
                    architecture: {
                        input_modalities: ['text'],
                        output_modalities: ['text']
                    },
                    free: false,
                    organization: 'meta-llama'
                },
                {
                    id: 'openrouter/auto',
                    name: 'Auto (Najlepszy model)',
                    description: 'Automatycznie wybiera najlepszy model dla twojego zadania. System rozpoznaje charakter zapytania i kieruje je do najodpowiedniejszego modelu, optymalizując jakość odpowiedzi przy kontroli kosztów.',
                    pricing: { prompt: '0.00003', completion: '0.00006' },
                    context_length: 128000,
                    architecture: {
                        input_modalities: ['text'],
                        output_modalities: ['text']
                    },
                    free: false,
                    organization: 'openrouter'
                },
                {
                    id: 'mistralai/mistral-7b-instruct',
                    name: 'Mistral 7B Instruct',
                    description: 'Darmowy model instruowany od Mistral AI. Mimo relatywnie małego rozmiaru oferuje dobrą jakość odpowiedzi dla podstawowych zadań. Doskonały do testowania i prototypowania rozwiązań AI.',
                    pricing: { prompt: '0.0', completion: '0.0' },
                    context_length: 32768,
                    architecture: {
                        input_modalities: ['text'],
                        output_modalities: ['text']
                    },
                    free: true,
                    organization: 'mistralai'
                }
            ];
            
            console.log(`Załadowano ${state.models.length} domyślnych modeli`);
        }

        // Konfiguracja nasłuchiwaczy zdarzeń
        function setupEventListeners() {
            // Menu mobilne
            elements.mobileMenuButton.addEventListener('click', toggleMobileSidebar);
            elements.mobileSidebarOverlay.addEventListener('click', toggleMobileSidebar);
            elements.mobileSettingsButton.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
            elements.mobileToggleTheme.addEventListener('click', toggleTheme);
            
            // Pole wiadomości
            elements.messageInput.addEventListener('input', updateCharacterCount);
            elements.messageInput.addEventListener('keydown', handleMessageInputKeydown);
            elements.messageForm.addEventListener('submit', handleMessageSubmit);
            elements.sendButton.addEventListener('click', handleMessageSubmit);
            
            // Kontrolki czatu
            elements.clearChat.addEventListener('click', clearCurrentChat);
            elements.newChat.addEventListener('click', createNewChat);
            
            // Modal ustawień
            elements.settingsButton.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
            elements.closeSettings.addEventListener('click', () => elements.settingsModal.classList.add('hidden'));
            
            // Kontrolki klucza API
            elements.toggleApiKey.addEventListener('click', toggleApiKeyVisibility);
            elements.saveApiKey.addEventListener('click', saveApiKey);
            elements.validateApiKey.addEventListener('click', validateApiKey);
            
            // Kontrolki motywu
            elements.lightTheme.addEventListener('click', () => applyTheme('light'));
            elements.darkTheme.addEventListener('click', () => applyTheme('dark'));
            elements.systemTheme.addEventListener('click', () => applyTheme('system'));
            elements.toggleTheme.addEventListener('click', toggleTheme);
            
            // Kontrolki historii czatu
            elements.exportChats.addEventListener('click', exportChatHistory);
            elements.importChats.addEventListener('click', () => elements.chatImportFile.click());
            elements.chatImportFile.addEventListener('change', importChatHistory);
            
            // Funkcjonalność porównywania
            elements.compareButton.addEventListener('click', showCompareModal);
            elements.closeCompare.addEventListener('click', () => elements.compareModal.classList.add('hidden'));
            
            // Modal informacji o modelu
            elements.closeModelInfo.addEventListener('click', () => elements.modelInfoModal.classList.add('hidden'));
            elements.selectModelFromInfo.addEventListener('click', () => {
                if (state.currentInfoModel) {
                    toggleModelSelection(state.currentInfoModel);
                    elements.modelInfoModal.classList.add('hidden');
                }
            });
            
            // Sortowanie i wyszukiwanie modeli
            elements.sortModels.addEventListener('change', renderModels);
            elements.modelSearch.addEventListener('input', debounce(renderModels, 300));
            
            // Filtry modeli
            elements.filterAll.addEventListener('click', () => setActiveFilter('all'));
            elements.filterFree.addEventListener('click', () => setActiveFilter('free'));
            elements.filterOpenAI.addEventListener('click', () => setActiveFilter('openai'));
            elements.filterAnthropic.addEventListener('click', () => setActiveFilter('anthropic'));
            elements.filterMeta.addEventListener('click', () => setActiveFilter('meta-llama'));
            
            // Zamykanie modali kliknięciem na zewnątrz
            window.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    elements.settingsModal.classList.add('hidden');
                }
                if (e.target === elements.compareModal) {
                    elements.compareModal.classList.add('hidden');
                }
                if (e.target === elements.modelInfoModal) {
                    elements.modelInfoModal.classList.add('hidden');
                }
            });
        }

        // Ustawienie aktywnego filtru
        function setActiveFilter(filter) {
            state.activeFilter = filter;
            
            // Aktualizacja stylu przycisków
            elements.filterAll.className = getFilterButtonClass(filter === 'all');
            elements.filterFree.className = getFilterButtonClass(filter === 'free');
            elements.filterOpenAI.className = getFilterButtonClass(filter === 'openai');
            elements.filterAnthropic.className = getFilterButtonClass(filter === 'anthropic');
            elements.filterMeta.className = getFilterButtonClass(filter === 'meta-llama');
            
            // Ponowne renderowanie modeli
            renderModels();
        }

        // Funkcja pomocnicza do ustawienia klasy przycisku filtra
        function getFilterButtonClass(isActive) {
            return `px-2 py-1 text-xs ${isActive ? 'bg-primary-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white'} rounded-md`;
        }

        // Przełączanie mobilnego paska bocznego
        function toggleMobileSidebar() {
            elements.sidebar.classList.toggle('hidden');
            elements.mobileSidebarOverlay.classList.toggle('hidden');
            
            if (!elements.sidebar.classList.contains('hidden')) {
                elements.sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-30', 'w-64');
            } else {
                elements.sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-30', 'w-64');
            }
        }

        // Renderowanie dostępnych modeli
        function renderModels() {
            if (state.models.length === 0) return;
            
            const sortValue = elements.sortModels.value;
            const searchTerm = elements.modelSearch.value.toLowerCase();
            
            // Filtrowanie modeli na podstawie wyszukiwanego hasła i aktywnego filtru
            let filteredModels = state.models.filter(model => {
                // Filtrowanie według wyszukiwania
                const matchesSearch = model.name.toLowerCase().includes(searchTerm) || 
                                     model.description.toLowerCase().includes(searchTerm);
                
                // Filtrowanie według aktywnego filtru
                let matchesFilter = true;
                if (state.activeFilter === 'free') {
                    matchesFilter = model.free;
                } else if (state.activeFilter !== 'all') {
                    matchesFilter = model.organization === state.activeFilter || 
                                   model.id.startsWith(state.activeFilter + '/');
                }
                
                return matchesSearch && matchesFilter;
            });
            
            // Sortowanie modeli na podstawie wybranej opcji
            filteredModels.sort((a, b) => {
                switch (sortValue) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'price-asc':
                        return (parseFloat(a.pricing.prompt) + parseFloat(a.pricing.completion)) - 
                               (parseFloat(b.pricing.prompt) + parseFloat(b.pricing.completion));
                    case 'price-desc':
                        return (parseFloat(b.pricing.prompt) + parseFloat(b.pricing.completion)) - 
                               (parseFloat(a.pricing.prompt) + parseFloat(a.pricing.completion));
                    case 'free-first':
                        if (a.free && !b.free) return -1;
                        if (!a.free && b.free) return 1;
                        return a.name.localeCompare(b.name);
                    default:
                        return 0;
                }
            });
            
            // Przeniesienie wybranych modeli na górę
// Znajdź aktualną zakładkę, aby wiedzieć, które modele są już wybrane
const currentTab = state.chatTabs.find(tab => tab.id === state.currentChatId);
const selectedModels = currentTab && currentTab.selectedModels ? currentTab.selectedModels : [];

// Przeniesienie wybranych modeli na górę
filteredModels.sort((a, b) => {
    const aSelected = selectedModels.includes(a.id);
    const bSelected = selectedModels.includes(b.id);
    
    if (aSelected && !bSelected) return -1;
    if (!aSelected && bSelected) return 1;
    return 0;
});
            // Wyczyszczenie listy modeli
            elements.modelList.innerHTML = '';
            
            // Jeśli nie ma modeli po filtrowaniu
            if (filteredModels.length === 0) {
                elements.modelList.innerHTML = `
                    <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Nie znaleziono modeli pasujących do kryteriów</p>
                    </div>
                `;
                return;
            }
            
            // Renderowanie każdego modelu
            filteredModels.forEach(model => {
                const isSelected = selectedModels.includes(model.id);
                
                const modelElement = document.createElement('div');
                modelElement.className = `p-3 rounded-md border ${isSelected ? 'border-primary-500 bg-primary-50 dark:bg-gray-700' : 'border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800'} cursor-pointer transition-colors duration-200`;
                modelElement.dataset.modelId = model.id;
                
modelElement.innerHTML = `
    <div class="flex items-start justify-between">
        <div class="flex-1">
            <div class="flex items-center">
                <h3 class="text-sm text-gray-800 dark:text-white">${model.name}</h3>
                ${model.free ? '<span class="ml-2 px-2 py-0.5 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 text-xs rounded-full">Darmowy</span>' : ''}
            </div>
        </div>
        <div class="flex flex-col items-end">
            <button class="info-button p-1 text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 mb-1" data-model-id="${model.id}">
                <i class="fas fa-info-circle"></i>
            </button>
            <button class="select-button p-1 text-gray-400 hover:text-primary-500 dark:hover:text-primary-400">
                <i class="fas ${isSelected ? 'fa-check-circle text-primary-500' : 'fa-circle'}"></i>
            </button>
        </div>
    </div>
`;
                
                // Dodanie nasłuchiwaczy zdarzeń
                const selectButton = modelElement.querySelector('.select-button');
                selectButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleModelSelection(model.id);
                });
                
                const infoButton = modelElement.querySelector('.info-button');
                infoButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showModelInfo(model.id);
                });
                
                // Dodanie nasłuchiwacza dla kliknięcia na cały element (dla wygody)
                modelElement.addEventListener('click', () => toggleModelSelection(model.id));
                
                elements.modelList.appendChild(modelElement);
            });
        }

        // Formatowanie ceny
        function formatPrice(price) {
            // Konwersja ceny na liczbę
            const priceNum = parseFloat(price);
            if (isNaN(priceNum) || priceNum === 0) return '0.00';
            
            // Formatowanie zależne od wielkości ceny
            if (priceNum < 0.0000001) {
                return (priceNum * 1000000000).toFixed(2) + 'n'; // nanocenty
            } else if (priceNum < 0.0001) {
                return (priceNum * 1000000).toFixed(2) + 'μ'; // microcenty
            } else if (priceNum < 0.1) {
                return (priceNum * 1000).toFixed(2) + 'm'; // milicenty
            } else {
                return priceNum.toFixed(2);
            }
        }

        // Pokazanie informacji o modelu
        function showModelInfo(modelId) {
            const model = state.models.find(m => m.id === modelId);
            if (!model) return;
            
            state.currentInfoModel = modelId;
            
            elements.modelInfoTitle.textContent = model.name;
            
            // Przygotowanie informacji o modalnościach
            let modalityInfo = '';
            if (model.architecture && model.architecture.input_modalities) {
                // Wartości do wyświetlenia
                const inputModalities = model.architecture.input_modalities || [];
                const outputModalities = model.architecture.output_modalities || [];
                
                const translateModality = (modality) => {
                    switch(modality) {
                        case 'text': return 'tekst';
                        case 'image': return 'obrazy';
                        case 'audio': return 'audio';
                        case 'video': return 'wideo';
                        default: return modality;
                    }
                };
                
                const inputStr = inputModalities.map(m => translateModality(m)).join(', ');
                const outputStr = outputModalities.map(m => translateModality(m)).join(', ');
                
                modalityInfo = `
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Obsługiwane wejścia:</span> ${inputStr || 'brak danych'}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Obsługiwane wyjścia:</span> ${outputStr || 'brak danych'}
                    </p>
                `;
            }
            
            // Przygotowanie informacji o cenach
            const promptPrice = parseFloat(model.pricing.prompt);
            const completionPrice = parseFloat(model.pricing.completion);
            
            // Oblicz koszty przykładowych operacji
            const examplePromptTokens = 1000;
            const exampleCompletionTokens = 500;
            const examplePromptCost = (promptPrice * examplePromptTokens).toFixed(6);
            const exampleCompletionCost = (completionPrice * exampleCompletionTokens).toFixed(6);
            const exampleTotalCost = (parseFloat(examplePromptCost) + parseFloat(exampleCompletionCost)).toFixed(6);
            
            elements.modelInfoContent.innerHTML = `
                <p class="text-gray-600 dark:text-gray-400">${model.description}</p>
                
                <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h4 class="font-medium text-gray-800 dark:text-white mb-2">Specyfikacja techniczna</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">ID modelu:</span> ${model.id}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Dostawca:</span> ${model.organization.charAt(0).toUpperCase() + model.organization.slice(1)}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Limit kontekstu:</span> ${model.context_length.toLocaleString()} tokenów
                    </p>
                    ${modalityInfo}
                </div>
                
                <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h4 class="font-medium text-gray-800 dark:text-white mb-2">Cennik</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Koszt promptu:</span> $${model.pricing.prompt}/token
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span class="font-medium">Koszt odpowiedzi:</span> $${model.pricing.completion}/token
                    </p>
                    <p class="text-sm mt-2 ${model.free ? 'text-green-600 dark:text-green-400' : 'text-gray-600 dark:text-gray-400'}">
                        <i class="fas ${model.free ? 'fa-check-circle' : 'fa-dollar-sign'} mr-1"></i>
                        ${model.free ? 'Darmowy model' : 'Model płatny'}
                    </p>
                </div>
                
                ${!model.free ? `
                <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h4 class="font-medium text-gray-800 dark:text-white mb-2">Przykładowy koszt</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        Przykład dla zapytania o długości ${examplePromptTokens} tokenów i odpowiedzi o długości ${exampleCompletionTokens} tokenów:
                    </p>
                    <ul class="text-sm text-gray-600 dark:text-gray-400 list-disc list-inside mt-1">
                        <li>Koszt promptu: $${examplePromptCost}</li>
                        <li>Koszt odpowiedzi: $${exampleCompletionCost}</li>
                        <li class="font-semibold">Łączny koszt: $${exampleTotalCost}</li>
                    </ul>
                </div>
                ` : ''}
            `;
            
            // Aktualizacja przycisku wyboru
// Aktualizacja przycisku wyboru - sprawdź czy model jest wybrany dla aktualnej zakładki
const currentTab = state.chatTabs.find(tab => tab.id === state.currentChatId);
const isSelected = currentTab && currentTab.selectedModels && currentTab.selectedModels.includes(modelId);
elements.selectModelFromInfo.textContent = isSelected ? 'Usuń model' : 'Wybierz model';
elements.selectModelFromInfo.className = `w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 ${isSelected ? 'bg-red-500 hover:bg-red-600' : 'bg-primary-500 hover:bg-primary-600'} text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm`;
            elements.modelInfoModal.classList.remove('hidden');
        }

        // Przełączanie wyboru modelu
function toggleModelSelection(modelId) {
    // Znajdź aktualną zakładkę
    const currentTab = state.chatTabs.find(tab => tab.id === state.currentChatId);
    if (!currentTab) return;
    
    // Jeśli zakładka nie ma jeszcze tablicy wybranych modeli, zainicjuj ją
    if (!currentTab.selectedModels) {
        currentTab.selectedModels = [];
    }
    
    const index = currentTab.selectedModels.indexOf(modelId);
    
    if (index === -1) {
        currentTab.selectedModels.push(modelId);
    } else {
        currentTab.selectedModels.splice(index, 1);
    }
    
    // Zapisanie do localStorage
    saveChatTabs();
    
    // Ponowne renderowanie modeli i wybranych modeli
    renderModels();
    renderSelectedModels();
    
    // Pokazanie/ukrycie przycisku porównania
    toggleCompareButton();
}

        // Renderowanie wybranych modeli
function renderSelectedModels() {
    elements.selectedModelsContainer.innerHTML = '';
    
    // Znajdź aktualną zakładkę
    const currentTab = state.chatTabs.find(tab => tab.id === state.currentChatId);
    if (!currentTab || !currentTab.selectedModels || currentTab.selectedModels.length === 0) {
        const noModels = document.createElement('div');
        noModels.className = 'text-sm text-gray-500 dark:text-gray-400 italic';
        noModels.textContent = 'Brak wybranych modeli. Wybierz modele z paska bocznego.';
        elements.selectedModelsContainer.appendChild(noModels);
        return;
    }
    
    currentTab.selectedModels.forEach(modelId => {
        const model = state.models.find(m => m.id === modelId);
        if (!model) return;
        
        const modelElement = document.createElement('div');
        modelElement.className = 'flex items-center px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm';
        modelElement.innerHTML = `
            <span class="font-medium text-gray-800 dark:text-white mr-2">${model.name}</span>
            <button class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-model-id="${model.id}">
                <i class="fas fa-times text-xs"></i>
            </button>
        `;
        
        const removeButton = modelElement.querySelector('button');
        removeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleModelSelection(model.id);
        });
        
        elements.selectedModelsContainer.appendChild(modelElement);
    });
}

        // Przełączanie widoczności przycisku porównania
function toggleCompareButton() {
    // Znajdź aktualną zakładkę
    const currentTab = state.chatTabs.find(tab => tab.id === state.currentChatId);
    if (!currentTab || !currentTab.selectedModels) {
        elements.compareButton.classList.add('hidden');
        return;
    }
    
    if (currentTab.selectedModels.length > 1) {
        elements.compareButton.classList.remove('hidden');
    } else {
        elements.compareButton.classList.add('hidden');
    }
}

        // Obsługa klawiszy w polu wiadomości
        function handleMessageInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleMessageSubmit(e);
            }
        }

        // Obsługa wysyłania wiadomości
        async function handleMessageSubmit(e) {
            e.preventDefault();
            
            const message = elements.messageInput.value.trim();
            if (!message) return;
            
            // Znajdź aktualną zakładkę
const currentTab = state.chatTabs.find(tab => tab.id === state.currentChatId);
if (!currentTab || !currentTab.selectedModels || currentTab.selectedModels.length === 0) {
    showToast('Wybierz przynajmniej jeden model AI dla tego czatu', 'warning');
    return;
}

// Dodanie wiadomości użytkownika do czatu
addMessageToChat('user', message, state.currentChatId);

// Wyczyszczenie pola wprowadzania
elements.messageInput.value = '';
updateCharacterCount();

// Pokazanie nakładki ładowania
elements.loadingOverlay.classList.remove('hidden');

try {
    // Wysłanie wiadomości do każdego wybranego modelu dla aktualnego czatu
    const responses = await Promise.all(
        currentTab.selectedModels.map(modelId => sendToOpenRouter(modelId, message))
    );
                
                // Dodanie odpowiedzi do czatu
// Dodanie odpowiedzi do czatu
responses.forEach((response, index) => {
    if (response && response.message) {
        // Używamy currentTab.selectedModels[index] zamiast state.selectedModels[index]
        addMessageToChat('assistant', response.message, state.currentChatId, currentTab.selectedModels[index]);
    }
});
                
                // Pokazanie przycisku porównania jeśli jest wiele odpowiedzi
                if (responses.length > 1) {
                    elements.compareButton.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Błąd:', error);
                addMessageToChat('assistant', 'Przepraszam, wystąpił błąd podczas przetwarzania Twojego zapytania.', state.currentChatId);
            } finally {
                // Ukrycie nakładki ładowania
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        // Wysyłanie wiadomości do API OpenRouter
// Wysyłanie wiadomości do API OpenRouter
async function sendToOpenRouter(modelId, message) {
    if (!state.apiKey) {
        throw new Error('Klucz API nie jest ustawiony');
    }
    
    // Przygotowanie historii wiadomości dla kontekstu
    const chatContext = [];
    
    // Dodaj wcześniejsze wiadomości z obecnego czatu (maksymalnie 20)
    if (state.chatHistory[state.currentChatId]) {
        const messages = state.chatHistory[state.currentChatId];
        const recentMessages = messages.slice(-20); // Weź maksymalnie 20 ostatnich wiadomości
        
        recentMessages.forEach(msg => {
            if (msg.role === 'user' || (msg.role === 'assistant' && msg.modelId === modelId)) {
                chatContext.push({
                    role: msg.role,
                    content: msg.content
                });
            }
        });
    }
    
    // Dodaj bieżącą wiadomość
    chatContext.push({
        role: 'user',
        content: message
    });
    
    try {
        console.log(`Wysyłanie zapytania do modelu ${modelId} z kontekstem:`, chatContext);
        
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${state.apiKey}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': window.location.href,
                'X-Title': 'Chat SS'
            },
            body: JSON.stringify({
                model: modelId,
                messages: chatContext,
                stream: false, // Wyłącz streaming dla uproszczenia
                temperature: 0.7,
                max_tokens: 2000
            })
        });
        
        // Sprawdź, czy odpowiedź jest prawidłowa
        if (!response.ok) {
            const errorText = await response.text();
            let errorMessage = `Status HTTP: ${response.status}`;
            
            try {
                // Próba parsowania JSON z błędem
                const errorData = JSON.parse(errorText);
                errorMessage = `Błąd API: ${errorData.error?.message || errorData.error || errorData.message || response.statusText}`;
                console.error(`Szczegóły błędu API dla ${modelId}:`, errorData);
            } catch {
                // Jeśli odpowiedź nie jest JSON
                errorMessage = `Błąd API: ${errorText || response.statusText}`;
            }
            
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        console.log(`Odpowiedź z modelu ${modelId}:`, data);
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error(`Nieprawidłowa struktura odpowiedzi z API dla modelu ${modelId}`);
        }
        
        return {
            modelId,
            message: data.choices[0].message.content
        };
    } catch (error) {
        console.error(`Błąd wysyłania do modelu ${modelId}:`, error);
        return {
            modelId,
            message: `Błąd: ${error.message}`
        };
    }
}

        // Dodanie wiadomości do czatu
        function addMessageToChat(role, content, chatId, modelId = null) {
            if (!state.chatHistory[chatId]) {
                state.chatHistory[chatId] = [];
            }
            
            const message = {
                id: Date.now().toString(),
                role,
                content,
                timestamp: new Date().toISOString(),
                modelId
            };
            
            state.chatHistory[chatId].push(message);
            saveChatHistory();
            
            // Renderowanie wiadomości
            renderMessage(message);
            
            // Przewinięcie na dół
            setTimeout(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }, 100);
			// Aktualizacja tytułu zakładki jeśli to pierwsza wiadomość użytkownika
if (role === 'user') {
    const tab = state.chatTabs.find(tab => tab.id === chatId);
    if (tab && (!tab.title || tab.title === 'Nowy czat')) {
        const truncatedContent = content.length > 20 ? content.substring(0, 20) + '...' : content;
        tab.title = truncatedContent;
        saveChatTabs();
        renderChatTabs();
    }
}
        }

        // Renderowanie wiadomości w czacie
        function renderMessage(message) {
            const isUser = message.role === 'user';
            const model = message.modelId ? state.models.find(m => m.id === message.modelId) : null;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-animation flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            messageElement.innerHTML = `
                <div class="flex max-w-3xl ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center ${isUser ? 'bg-primary-500 text-white ml-3' : 'bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white mr-3'}">
                        ${isUser ? '<i class="fas fa-user"></i>' : (model ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-question"></i>')}
                    </div>
                    <div class="${isUser ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'} px-4 py-2 rounded-lg">
                        ${!isUser && model ? `<div class="text-xs font-medium mb-1 ${isUser ? 'text-primary-100' : 'text-gray-500 dark:text-gray-400'}">${model.name}</div>` : ''}
                        <div class="whitespace-pre-wrap">${escapeHtml(message.content)}</div>
                        <div class="mt-1 text-xs ${isUser ? 'text-primary-300' : 'text-gray-500 dark:text-gray-400'}">${formatTime(message.timestamp)}</div>
                    </div>
                </div>
            `;
            
            elements.chatMessages.appendChild(messageElement);
        }
// Tworzenie nowego czatu
function createNewChat() {
    const chatId = `chat_${Date.now()}`;
    state.currentChatId = chatId;
    
    // Inicjalizacja pustej historii czatu
    if (!state.chatHistory[chatId]) {
        state.chatHistory[chatId] = [];
    }
    
    // Zapisanie do localStorage
    saveChatHistory();
    localStorage.setItem('currentChatId', chatId);
    
    // Dodanie nowej zakładki
state.chatTabs.push({
    id: chatId,
    title: 'Nowy czat',
    timestamp: new Date().toISOString(),
    selectedModels: []  // Dodane pole dla wybranych modeli tego czatu
});
    
    // Zapisanie zakładek
    saveChatTabs();
    
    // Renderowanie zakładek
    renderChatTabs();
    
    // Aktywacja nowej zakładki
    activateTab(chatId);
	
}
// Zapisanie zakładek czatu
function saveChatTabs() {
    localStorage.setItem('chatTabs', JSON.stringify(state.chatTabs));
}

// Renderowanie zakładek czatu
function renderChatTabs() {
    elements.chatTabs.innerHTML = '';
    
    if (state.chatTabs.length === 0) {
        return;
    }
    
    state.chatTabs.forEach(tab => {
        const isActive = tab.id === state.currentChatId;
        
        const tabElement = document.createElement('div');
        tabElement.className = `chat-tab px-4 py-2 rounded-md cursor-pointer flex items-center ${
            isActive 
            ? 'bg-primary-500 text-white' 
            : 'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500'
        }`;
        tabElement.dataset.chatId = tab.id;
        
        tabElement.innerHTML = `
            <i class="fas fa-comment-alt mr-2 text-sm"></i>
            <span class="truncate max-w-xs">${tab.title || 'Nowy czat'}</span>
            <span class="tab-close ml-2" data-chat-id="${tab.id}">
                <i class="fas fa-times"></i>
            </span>
        `;
        
        elements.chatTabs.appendChild(tabElement);
    });
}

// Aktywacja wybranej zakładki
function activateTab(chatId) {
    // Aktualizacja aktualnego czatu
    state.currentChatId = chatId;
    localStorage.setItem('currentChatId', chatId);
    
    // Aktualizacja wyglądu zakładek
    renderChatTabs();
    
    // Wyczyszczenie wiadomości czatu
    elements.chatMessages.innerHTML = '';
    
    // Jeżeli historia czatu istnieje, załaduj wiadomości
    if (state.chatHistory[chatId] && state.chatHistory[chatId].length > 0) {
        // Renderowanie wszystkich wiadomości
        state.chatHistory[chatId].forEach(message => {
            renderMessage(message);
        });
        
        // Przewijanie na dół
        setTimeout(() => {
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }, 100);
    } else {
        // Brak wiadomości w czacie
        elements.chatMessages.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <i class="fas fa-comments text-4xl mb-2"></i>
                <p>Rozpocznij rozmowę z wybranymi modelami AI</p>
            </div>
        `;
    }
	// Aktualizacja listy wybranych modeli dla aktywnej zakładki
    renderSelectedModels();
    
    // Aktualizacja przycisku porównania
    toggleCompareButton();
}

// Zamykanie zakładki czatu
function closeTab(chatId) {
    // Sprawdzenie czy to ostatnia zakładka
    if (state.chatTabs.length <= 1) {
        showToast('Nie można zamknąć ostatniej zakładki', 'warning');
        return;
    }
    
    // Potwierdzenie zamknięcia
    if (confirm('Czy na pewno chcesz zamknąć tę zakładkę? Historia czatu zostanie zachowana.')) {
        // Znalezienie indeksu zakładki do usunięcia
        const tabIndex = state.chatTabs.findIndex(tab => tab.id === chatId);
        
        if (tabIndex !== -1) {
            // Usunięcie zakładki
            state.chatTabs.splice(tabIndex, 1);
            saveChatTabs();
            
            // Jeżeli to była aktywna zakładka, aktywuj inną
            if (chatId === state.currentChatId) {
                // Wybierz następną zakładkę lub poprzednią jeśli to była ostatnia
                const newTabIndex = tabIndex >= state.chatTabs.length ? tabIndex - 1 : tabIndex;
                const newChatId = state.chatTabs[newTabIndex].id;
                activateTab(newChatId);
            } else {
                // Po prostu odśwież zakładki jeśli to nie była aktywna zakładka
                renderChatTabs();
            }
        }
    }
}
        // Wczytanie czatu z historii
        function loadChat(chatId) {
            if (!state.chatHistory[chatId]) return;
            
            state.currentChatId = chatId;
            localStorage.setItem('currentChatId', chatId);
            
            // Wyczyszczenie wiadomości czatu
            elements.chatMessages.innerHTML = '';
            
            // Renderowanie wszystkich wiadomości
            state.chatHistory[chatId].forEach(message => {
                renderMessage(message);
            });
            
            // Przewijanie na dół jeśli są wiadomości
            if (state.chatHistory[chatId].length > 0) {
                setTimeout(() => {
                    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                }, 100);
            }
        }

        // Wyczyszczenie aktualnego czatu
        function clearCurrentChat() {
            if (!state.currentChatId) return;
            
            if (confirm('Czy na pewno chcesz wyczyścić ten czat?')) {
                state.chatHistory[state.currentChatId] = [];
                saveChatHistory();
                
                // Wyczyszczenie wiadomości czatu
                elements.chatMessages.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i class="fas fa-comments text-4xl mb-2"></i>
                        <p>Rozpocznij rozmowę z wybranymi modelami AI</p>
                    </div>
                `;
            }
			// Zresetowanie tytułu zakładki
const tabIndex = state.chatTabs.findIndex(tab => tab.id === state.currentChatId);
if (tabIndex !== -1) {
    state.chatTabs[tabIndex].title = 'Nowy czat';
    saveChatTabs();
    renderChatTabs();
}
        }

        // Zapisanie historii czatu do localStorage
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(state.chatHistory));
        }

        // Aktualizacja licznika znaków
        function updateCharacterCount() {
            const count = elements.messageInput.value.length;
            elements.characterCount.textContent = count;
            
            if (count > 1000) {
                elements.characterCount.classList.add('text-red-500');
            } else {
                elements.characterCount.classList.remove('text-red-500');
            }
        }

        // Przełączanie widoczności klucza API
        function toggleApiKeyVisibility() {
            const isPassword = elements.apiKeyInput.type === 'password';
            elements.apiKeyInput.type = isPassword ? 'text' : 'password';
            elements.toggleApiKey.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        }

        // Zapisanie klucza API
        function saveApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();
            state.apiKey = apiKey;
            localStorage.setItem('openRouterApiKey', apiKey);
            
            // Ponowne pobranie modeli
            fetchModels();
            
            // Pokazanie komunikatu sukcesu
            showToast('Klucz API zapisany pomyślnie');
        }

        // Weryfikacja klucza API
// Weryfikacja klucza API
async function validateApiKey() {
    const apiKey = elements.apiKeyInput.value.trim();
    
    if (!apiKey) {
        showToast('Proszę najpierw wprowadzić klucz API', 'error');
        return;
    }
    
    try {
        elements.loadingOverlay.classList.remove('hidden');
        
        const response = await fetch('https://openrouter.ai/api/v1/auth/key', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiKey}`
            }
        });
        
        // Pobierz tekst odpowiedzi przed sprawdzeniem statusu
        const responseText = await response.text();
        let responseData;
        
        try {
            // Próba parsowania odpowiedzi jako JSON
            responseData = JSON.parse(responseText);
        } catch (e) {
            console.error('Błąd parsowania JSON z odpowiedzi:', e);
            throw new Error(`Nieoczekiwana odpowiedź od API: ${responseText.substring(0, 100)}...`);
        }
        
        if (!response.ok) {
            let errorMessage = `Weryfikacja klucza API nie powiodła się (status ${response.status})`;
            if (responseData && responseData.error) {
                errorMessage += `: ${responseData.error.message || JSON.stringify(responseData.error)}`;
            }
            throw new Error(errorMessage);
        }
        
        // Wyświetl szczegóły klucza API
        console.log('Dane klucza API:', responseData);
        
        if (responseData && responseData.data) {
            const { usage, limit, is_free_tier } = responseData.data;
            const remainingCredits = limit !== null ? (limit - usage).toFixed(2) : 'Nieograniczone';
            const accountType = is_free_tier ? 'darmowe' : 'płatne';
            
            showToast(`Klucz API jest ważny. Pozostałe kredyty: ${remainingCredits}. Konto: ${accountType}`, 'success');
            
            // Automatyczne zapisanie klucza, jeśli jest prawidłowy
            state.apiKey = apiKey;
            localStorage.setItem('openRouterApiKey', apiKey);
            
            // Ponowne pobranie modeli
            fetchModels();
        } else {
            showToast(`Klucz API jest ważny, ale nie udało się odczytać szczegółów konta.`, 'warning');
        }
    } catch (error) {
        console.error('Błąd weryfikacji klucza API:', error);
        showToast(`Błąd: ${error.message}`, 'error');
    } finally {
        elements.loadingOverlay.classList.add('hidden');
    }
}

        // Zastosowanie motywu
        function applyTheme(theme) {
            state.theme = theme;
            localStorage.setItem('theme', theme);
            
            // Aktualizacja przycisków motywu
            elements.lightTheme.classList.remove('bg-primary-500', 'text-white');
            elements.darkTheme.classList.remove('bg-primary-500', 'text-white');
            elements.systemTheme.classList.remove('bg-primary-500', 'text-white');
            
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                elements.lightTheme.classList.add('bg-primary-500', 'text-white');
            } else if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.darkTheme.classList.add('bg-primary-500', 'text-white');
            } else {
                // Motyw systemowy - sprawdź prefers-color-scheme
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                elements.systemTheme.classList.add('bg-primary-500', 'text-white');
            }
        }

        // Przełączanie motywu
        function toggleTheme() {
            const themes = ['light', 'dark', 'system'];
            const currentIndex = themes.indexOf(state.theme);
            const nextIndex = (currentIndex + 1) % themes.length;
            applyTheme(themes[nextIndex]);
        }

        // Eksport historii czatu
function exportChatHistory() {
    if (Object.keys(state.chatHistory).length === 0) {
        showToast('Brak historii czatu do eksportu', 'warning');
        return;
    }
    
    const exportData = {
        chatHistory: state.chatHistory,
        chatTabs: state.chatTabs
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `chat-ss-${new Date().toISOString().slice(0, 10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showToast('Historia czatu wyeksportowana pomyślnie');
}

        // Import historii czatu
        function importChatHistory() {
    const file = elements.chatImportFile.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            
            if (imported.chatHistory) {
                // Połączenie z istniejącą historią
                state.chatHistory = { ...state.chatHistory, ...imported.chatHistory };
                saveChatHistory();
            }
            
            if (imported.chatTabs) {
                state.chatTabs = imported.chatTabs;
                saveChatTabs();
                renderChatTabs();
            }
            
            showToast('Historia czatu zaimportowana pomyślnie');
            
            // Jeśli aktualnie wybrany czat nie istnieje, utwórz nowy
            if (!state.currentChatId || !state.chatHistory[state.currentChatId]) {
                createNewChat();
            } else {
                activateTab(state.currentChatId);
            }
        } catch (error) {
            console.error('Błąd importu historii czatu:', error);
            showToast('Błąd importu historii czatu', 'error');
        }
    };
    reader.readAsText(file);
    
    // Resetowanie pola wejściowego pliku
    elements.chatImportFile.value = '';
}

        // Pokazanie modalu porównywania
        function showCompareModal() {
            if (!state.currentChatId || state.chatHistory[state.currentChatId].length === 0) {
                showToast('Brak wiadomości do porównania', 'warning');
                return;
            }
            
            // Pobranie ostatniej wiadomości użytkownika i wszystkich odpowiedzi asystenta
            const chat = state.chatHistory[state.currentChatId];
            const lastUserMessage = [...chat].reverse().find(m => m.role === 'user');
            
            if (!lastUserMessage) {
                showToast('Nie znaleziono wiadomości użytkownika do porównania', 'warning');
                return;
            }
            
            const assistantResponses = chat.filter(m => 
                m.role === 'assistant' && 
                m.timestamp > lastUserMessage.timestamp
            );
            
            if (assistantResponses.length < 2) {
                showToast('Potrzeba co najmniej 2 odpowiedzi modeli do porównania', 'warning');
                return;
            }
            
            // Renderowanie porównania
            elements.compareResults.innerHTML = `
                <div class="col-span-1 md:col-span-2">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
                        <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Wiadomość użytkownika</div>
                        <div class="whitespace-pre-wrap bg-white dark:bg-gray-800 p-3 rounded">${escapeHtml(lastUserMessage.content)}</div>
                    </div>
                </div>
            `;
            
            assistantResponses.forEach(response => {
                const model = state.models.find(m => m.id === response.modelId);
                
                const responseElement = document.createElement('div');
                responseElement.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                responseElement.innerHTML = `
                    <div class="flex items-center mb-2">
                        <div class="h-6 w-6 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-2">
                            <i class="fas fa-robot text-xs"></i>
                        </div>
                        <h4 class="font-medium">${model ? model.name : 'Nieznany model'}</h4>
                    </div>
                    <div class="whitespace-pre-wrap text-gray-800 dark:text-gray-200">${escapeHtml(response.content)}</div>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">${formatTime(response.timestamp)}</div>
                `;
                
                elements.compareResults.appendChild(responseElement);
            });
            
            elements.compareModal.classList.remove('hidden');
        }

        // Pokazanie powiadomienia toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-yellow-500'
            } z-50 flex items-center`;
            
            toast.innerHTML = `
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    'fa-exclamation-triangle'
                } mr-2"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .replace(/\n/g, '<br>');
}

        // Funkcja pomocnicza do formatowania czasu
function formatTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

        // Funkcja pomocnicza do opóźnienia wykonania
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
// Nasłuchiwacze zakładek: delegowany event listener dla dynamicznych elementów
document.addEventListener('click', function(event) {
    // Sprawdzenie, czy kliknięcie było na przycisku zamykania zakładki
    const closeButton = event.target.closest('.tab-close');
    if (closeButton && closeButton.dataset.chatId) {
        event.stopPropagation();
        closeTab(closeButton.dataset.chatId);
    }
    
    // Sprawdzenie, czy kliknięcie było na zakładce
    const tabElement = event.target.closest('.chat-tab');
    if (tabElement && tabElement.dataset.chatId && !event.target.closest('.tab-close')) {
        activateTab(tabElement.dataset.chatId);
    }
});
        // Inicjalizacja aplikacji po załadowaniu DOM
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
