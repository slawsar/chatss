<!DOCTYPE html>
<html lang="pl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat SS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Niestandardowy pasek przewijania */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Animacja dla wiadomości */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-animation {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Styl dla przeciągnij i upuść */
        .drag-over {
            border: 2px dashed #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div id="app" class="h-full flex flex-col">
        <!-- Nagłówek/Nawigacja -->
        <header class="bg-white dark:bg-gray-800 shadow-sm z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <!-- Logo i przycisk menu mobilnego -->
                    <div class="flex items-center">
                        <button id="mobile-menu-button" class="md:hidden text-gray-500 dark:text-gray-400 mr-2">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <div class="flex items-center">
                            <i class="fas fa-robot text-primary-500 text-2xl mr-2"></i>
                            <span class="text-xl font-bold text-gray-800 dark:text-white">Chat SS</span>
                        </div>
                    </div>

                    <!-- Nawigacja desktopowa -->
                    <nav class="hidden md:flex items-center space-x-4">
                        <button id="toggle-theme" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                        <button id="settings-button" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="compare-button" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 hidden">
                            <i class="fas fa-exchange-alt mr-2"></i>Porównaj modele
                        </button>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Główny obszar zawartości -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Pasek boczny (ukryty na urządzeniach mobilnych) -->
            <aside id="sidebar" class="hidden md:block w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 overflow-y-auto">
                <div class="p-4">
                    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Dostępne modele</h2>
                    
                    <!-- Kontrolki sortowania modeli -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sortuj według:</label>
                        <select id="sort-models" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                            <option value="name-asc">Nazwa (A-Z)</option>
                            <option value="name-desc">Nazwa (Z-A)</option>
                            <option value="price-asc">Cena (od najniższej)</option>
                            <option value="price-desc">Cena (od najwyższej)</option>
                            <option value="free-first">Darmowe najpierw</option>
                        </select>
                    </div>
                    
                    <!-- Wyszukiwanie modeli -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Szukaj:</label>
                        <input type="text" id="model-search" placeholder="Szukaj modeli..." class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                    </div>
                    
                    <!-- Lista modeli -->
                    <div id="model-list" class="space-y-2">
                        <!-- Modele będą wypełnione przez JavaScript -->
                        <div class="flex justify-center py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"></div>
                            <span class="ml-2">Ładowanie modeli...</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Nakładka paska bocznego na urządzeniach mobilnych -->
            <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

            <!-- Główny obszar czatu -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Nagłówek czatu z wybranymi modelami -->
                <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Czat</h2>
                        <button id="clear-chat" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                            <i class="fas fa-trash-alt mr-1"></i> Wyczyść czat
                        </button>
                    </div>
                    <div id="selected-models" class="flex flex-wrap gap-2 mt-2">
                        <!-- Wybrane modele pojawią się tutaj -->
                    </div>
                </div>

                <!-- Wiadomości czatu -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i class="fas fa-comments text-4xl mb-2"></i>
                        <p>Rozpocznij rozmowę z wybranymi modelami AI</p>
                    </div>
                </div>

                <!-- Pole wprowadzania wiadomości -->
                <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
                    <form id="message-form" class="flex space-x-2">
                        <div class="flex-1 relative">
                            <textarea id="message-input" rows="1" placeholder="Wpisz swoją wiadomość..." class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 resize-none pr-10" style="min-height: 44px;"></textarea>
                            <button type="button" id="send-button" class="absolute right-2 bottom-2 text-primary-500 hover:text-primary-600">
                                <i class="fas fa-paper-plane text-xl"></i>
                            </button>
                        </div>
                    </form>
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500 dark:text-gray-400">
                        <div>
                            <span id="character-count">0</span>/1000
                        </div>
                        <div>
                            <button type="button" id="new-chat" class="hover:text-gray-700 dark:hover:text-gray-300">
                                <i class="fas fa-plus mr-1"></i> Nowy czat
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Ustawień -->
    <div id="settings-modal" class="fixed inset-0 z-30 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Ustawienia</h3>
                    
                    <div class="space-y-4">
                        <!-- Sekcja klucza API -->
                        <div>
                            <label for="api-key" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Klucz API OpenRouter</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <input type="password" id="api-key" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500 pr-10" placeholder="sk-or-xxxxxxxxxxxxxxxx">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                    <button type="button" id="toggle-api-key" class="text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Twój klucz API jest przechowywany lokalnie w przeglądarce.</p>
                            <div class="mt-2">
                                <button id="save-api-key" class="px-3 py-1 bg-primary-500 text-white text-sm rounded-md hover:bg-primary-600">
                                    Zapisz klucz API
                                </button>
                                <button id="validate-api-key" class="ml-2 px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    Weryfikuj klucz
                                </button>
                            </div>
                        </div>

                        <!-- Wybór motywu -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Motyw</label>
                            <div class="mt-1 flex space-x-4">
                                <button id="light-theme" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-sun mr-1"></i> Jasny
                                </button>
                                <button id="dark-theme" class="px-3 py-2 bg-gray-800 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-moon mr-1"></i> Ciemny
                                </button>
                                <button id="system-theme" class="px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                    <i class="fas fa-desktop mr-1"></i> Systemowy
                                </button>
                            </div>
                        </div>

                        <!-- Historia czatu -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Historia czatu</label>
                            <div class="mt-1 flex space-x-2">
                                <button id="export-chats" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    <i class="fas fa-download mr-1"></i> Eksportuj
                                </button>
                                <button id="import-chats" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white text-sm rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                                    <i class="fas fa-upload mr-1"></i> Importuj
                                </button>
                                <input type="file" id="chat-import-file" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-settings" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-500 text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Zamknij
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal porównywania -->
    <div id="compare-modal" class="fixed inset-0 z-30 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Porównaj odpowiedzi modeli</h3>
                    
                    <div id="compare-results" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Tutaj pojawią się wyniki porównania -->
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-compare" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-500 text-base font-medium text-white hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Zamknij
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nakładka ładowania -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                <span class="ml-3 text-lg text-gray-800 dark:text-white">Przetwarzanie żądania...</span>
            </div>
        </div>
    </div>

    <script>
        // Główny stan aplikacji
        const state = {
            apiKey: localStorage.getItem('openRouterApiKey') || '',
            selectedModels: JSON.parse(localStorage.getItem('selectedModels')) || [],
            chatHistory: JSON.parse(localStorage.getItem('chatHistory')) || {},
            currentChatId: localStorage.getItem('currentChatId') || null,
            theme: localStorage.getItem('theme') || 'system',
            models: []
        };

        // Elementy DOM
        const elements = {
            app: document.getElementById('app'),
            mobileMenuButton: document.getElementById('mobile-menu-button'),
            sidebar: document.getElementById('sidebar'),
            mobileSidebarOverlay: document.getElementById('mobile-sidebar-overlay'),
            modelList: document.getElementById('model-list'),
            selectedModelsContainer: document.getElementById('selected-models'),
            chatMessages: document.getElementById('chat-messages'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            characterCount: document.getElementById('character-count'),
            clearChat: document.getElementById('clear-chat'),
            newChat: document.getElementById('new-chat'),
            settingsButton: document.getElementById('settings-button'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettings: document.getElementById('close-settings'),
            apiKeyInput: document.getElementById('api-key'),
            toggleApiKey: document.getElementById('toggle-api-key'),
            saveApiKey: document.getElementById('save-api-key'),
            validateApiKey: document.getElementById('validate-api-key'),
            lightTheme: document.getElementById('light-theme'),
            darkTheme: document.getElementById('dark-theme'),
            systemTheme: document.getElementById('system-theme'),
            toggleTheme: document.getElementById('toggle-theme'),
            exportChats: document.getElementById('export-chats'),
            importChats: document.getElementById('import-chats'),
            chatImportFile: document.getElementById('chat-import-file'),
            compareButton: document.getElementById('compare-button'),
            compareModal: document.getElementById('compare-modal'),
            closeCompare: document.getElementById('close-compare'),
            compareResults: document.getElementById('compare-results'),
            sortModels: document.getElementById('sort-models'),
            modelSearch: document.getElementById('model-search'),
            loadingOverlay: document.getElementById('loading-overlay')
        };

        // Inicjalizacja aplikacji
        async function init() {
            // Konfiguracja nasłuchiwaczy zdarzeń
            setupEventListeners();
            
            // Zastosowanie zapisanego motywu
            applyTheme(state.theme);
            
            // Wypełnienie pola API key
            if (state.apiKey) {
                elements.apiKeyInput.value = state.apiKey;
            }
            
            // Pobieranie modeli z OpenRouter API
            await fetchModels();
            
            // Renderowanie wybranych modeli
            renderSelectedModels();
            
            // Tworzenie nowego czatu jeżeli nie istnieje
            if (!state.currentChatId || !state.chatHistory[state.currentChatId]) {
                createNewChat();
            } else {
                loadChat(state.currentChatId);
            }
            
            // Pokazanie przycisku porównania jeżeli wybrano wiele modeli
            toggleCompareButton();
        }

        // Funkcja pobierająca modele z OpenRouter API
        async function fetchModels() {
            try {
                let models = [];
                
                if (state.apiKey) {
                    // Próba pobrania modeli z API
                    try {
                        const response = await fetch('https://openrouter.ai/api/v1/models', {
                            headers: {
                                'Authorization': `Bearer ${state.apiKey}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            models = data.data.map(model => ({
                                id: model.id,
                                name: model.name,
                                description: model.description || 'Brak opisu',
                                pricing: model.pricing || { prompt: '0', completion: '0' },
                                context_length: model.context_length || 4096,
                                free: (parseFloat(model.pricing?.prompt) === 0 && parseFloat(model.pricing?.completion) === 0)
                            }));
                        } else {
                            throw new Error('Nie udało się pobrać modeli z API');
                        }
                    } catch (error) {
                        console.error('Błąd podczas pobierania modeli:', error);
                        // Fallback do domyślnych modeli
                        useDefaultModels();
                    }
                } else {
                    // Brak klucza API, użyj domyślnych modeli
                    useDefaultModels();
                }
                
                // Zapisz pobrane modele
                state.models = models;
                
                // Renderuj listę modeli
                renderModels();
            } catch (error) {
                console.error('Błąd podczas inicjalizacji modeli:', error);
                elements.modelList.innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <i class="fas fa-exclamation-circle mb-2"></i>
                        <p>Błąd podczas ładowania modeli</p>
                    </div>
                `;
            }
        }

        // Funkcja ustawiająca domyślne modele
        function useDefaultModels() {
            state.models = [
                {
                    id: 'openai/gpt-3.5-turbo',
                    name: 'GPT-3.5 Turbo',
                    description: 'Szybki i wydajny model od OpenAI',
                    pricing: { prompt: '0.0000015', completion: '0.000002' },
                    context_length: 4096,
                    free: false
                },
                {
                    id: 'openai/gpt-4o',
                    name: 'GPT-4o',
                    description: 'Najbardziej zaawansowany model od OpenAI',
                    pricing: { prompt: '0.00003', completion: '0.00006' },
                    context_length: 128000,
                    free: false
                },
                {
                    id: 'anthropic/claude-3.5-sonnet',
                    name: 'Claude 3.5 Sonnet',
                    description: 'Najnowszy model od Anthropic',
                    pricing: { prompt: '0.00001102', completion: '0.00003268' },
                    context_length: 200000,
                    free: false
                },
                {
                    id: 'google/gemini-pro',
                    name: 'Gemini Pro',
                    description: 'Zaawansowany model od Google',
                    pricing: { prompt: '0.0000005', completion: '0.0000005' },
                    context_length: 32768,
                    free: false
                },
                {
                    id: 'meta-llama/llama-3.1-70b-instruct',
                    name: 'Llama 3.1 70B',
                    description: 'Duży model od Meta',
                    pricing: { prompt: '0.0000007', completion: '0.0000009' },
                    context_length: 128000,
                    free: false
                },
                {
                    id: 'openrouter/auto',
                    name: 'Auto (Najlepszy model)',
                    description: 'Automatycznie wybiera najlepszy model dla twojego zadania',
                    pricing: { prompt: '0.00003', completion: '0.00006' },
                    context_length: 128000,
                    free: false
                },
                {
                    id: 'mistralai/mistral-7b-instruct',
                    name: 'Mistral 7B Instruct',
                    description: 'Instruowany model Mistral 7B',
                    pricing: { prompt: '0.0', completion: '0.0' },
                    context_length: 32768,
                    free: true
                }
            ];
        }

        // Konfiguracja nasłuchiwaczy zdarzeń
        function setupEventListeners() {
            // Menu mobilne
            elements.mobileMenuButton.addEventListener('click', toggleMobileSidebar);
            elements.mobileSidebarOverlay.addEventListener('click', toggleMobileSidebar);
            
            // Pole wiadomości
            elements.messageInput.addEventListener('input', updateCharacterCount);
            elements.messageInput.addEventListener('keydown', handleMessageInputKeydown);
            elements.messageForm.addEventListener('submit', handleMessageSubmit);
            elements.sendButton.addEventListener('click', handleMessageSubmit);
            
            // Kontrolki czatu
            elements.clearChat.addEventListener('click', clearCurrentChat);
            elements.newChat.addEventListener('click', createNewChat);
            
            // Modal ustawień
            elements.settingsButton.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
            elements.closeSettings.addEventListener('click', () => elements.settingsModal.classList.add('hidden'));
            
            // Kontrolki klucza API
            elements.toggleApiKey.addEventListener('click', toggleApiKeyVisibility);
            elements.saveApiKey.addEventListener('click', saveApiKey);
            elements.validateApiKey.addEventListener('click', validateApiKey);
            
            // Kontrolki motywu
            elements.lightTheme.addEventListener('click', () => applyTheme('light'));
            elements.darkTheme.addEventListener('click', () => applyTheme('dark'));
            elements.systemTheme.addEventListener('click', () => applyTheme('system'));
            elements.toggleTheme.addEventListener('click', toggleTheme);
            
            // Kontrolki historii czatu
            elements.exportChats.addEventListener('click', exportChatHistory);
            elements.importChats.addEventListener('click', () => elements.chatImportFile.click());
            elements.chatImportFile.addEventListener('change', importChatHistory);
            
            // Funkcjonalność porównywania
            elements.compareButton.addEventListener('click', showCompareModal);
            elements.closeCompare.addEventListener('click', () => elements.compareModal.classList.add('hidden'));
            
            // Sortowanie i wyszukiwanie modeli
            elements.sortModels.addEventListener('change', renderModels);
            elements.modelSearch.addEventListener('input', debounce(renderModels, 300));
            
            // Zamykanie modali kliknięciem na zewnątrz
            window.addEventListener('click', (e) => {
                if (e.target === elements.settingsModal) {
                    elements.settingsModal.classList.add('hidden');
                }
                if (e.target === elements.compareModal) {
                    elements.compareModal.classList.add('hidden');
                }
            });
        }

        // Przełączanie mobilnego paska bocznego
        function toggleMobileSidebar() {
            elements.sidebar.classList.toggle('hidden');
            elements.mobileSidebarOverlay.classList.toggle('hidden');
            
            if (!elements.sidebar.classList.contains('hidden')) {
                elements.sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-30', 'w-64');
            } else {
                elements.sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-30', 'w-64');
            }
        }

        // Renderowanie dostępnych modeli
        function renderModels() {
            if (state.models.length === 0) return;
            
            const sortValue = elements.sortModels.value;
            const searchTerm = elements.modelSearch.value.toLowerCase();
            
            // Filtrowanie modeli na podstawie wyszukiwanego hasła
            let filteredModels = state.models.filter(model => 
                model.name.toLowerCase().includes(searchTerm) || 
                model.description.toLowerCase().includes(searchTerm)
            );
            
            // Sortowanie modeli na podstawie wybranej opcji
            filteredModels.sort((a, b) => {
                switch (sortValue) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'price-asc':
                        return (parseFloat(a.pricing.prompt) + parseFloat(a.pricing.completion)) - 
                               (parseFloat(b.pricing.prompt) + parseFloat(b.pricing.completion));
                    case 'price-desc':
                        return (parseFloat(b.pricing.prompt) + parseFloat(b.pricing.completion)) - 
                               (parseFloat(a.pricing.prompt) + parseFloat(a.pricing.completion));
                    case 'free-first':
                        if (a.free && !b.free) return -1;
                        if (!a.free && b.free) return 1;
                        return a.name.localeCompare(b.name);
                    default:
                        return 0;
                }
            });
            
            // Przeniesienie wybranych modeli na górę
            filteredModels.sort((a, b) => {
                const aSelected = state.selectedModels.includes(a.id);
                const bSelected = state.selectedModels.includes(b.id);
                
                if (aSelected && !bSelected) return -1;
                if (!aSelected && bSelected) return 1;
                return 0;
            });
            
            // Wyczyszczenie listy modeli
            elements.modelList.innerHTML = '';
            
            // Renderowanie każdego modelu
            filteredModels.forEach(model => {
                const isSelected = state.selectedModels.includes(model.id);
                
                const modelElement = document.createElement('div');
                modelElement.className = `p-3 rounded-md border ${isSelected ? 'border-primary-500 bg-primary-50 dark:bg-gray-700' : 'border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800'} cursor-pointer transition-colors duration-200`;
                modelElement.dataset.modelId = model.id;
                
                modelElement.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <h3 class="font-medium text-gray-800 dark:text-white">${model.name}</h3>
                                ${model.free ? '<span class="ml-2 px-2 py-0.5 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 text-xs rounded-full">Darmowy</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${model.description}</p>
                            <div class="mt-2 flex items-center text-xs text-gray-500 dark:text-gray-400">
                                <span class="mr-3"><i class="fas fa-dollar-sign mr-1"></i> ${model.pricing.prompt}/token (prompt)</span>
                                <span><i class="fas fa-dollar-sign mr-1"></i> ${model.pricing.completion}/token (completion)</span>
                            </div>
                        </div>
                        <div class="ml-2">
                            <button class="p-1 text-gray-400 hover:text-primary-500 dark:hover:text-primary-400">
                                <i class="fas ${isSelected ? 'fa-check-circle text-primary-500' : 'fa-circle'}"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                modelElement.addEventListener('click', () => toggleModelSelection(model.id));
                elements.modelList.appendChild(modelElement);
            });
        }

        // Przełączanie wyboru modelu
        function toggleModelSelection(modelId) {
            const index = state.selectedModels.indexOf(modelId);
            
            if (index === -1) {
                state.selectedModels.push(modelId);
            } else {
                state.selectedModels.splice(index, 1);
            }
            
            // Zapisanie do localStorage
            localStorage.setItem('selectedModels', JSON.stringify(state.selectedModels));
            
            // Ponowne renderowanie modeli i wybranych modeli
            renderModels();
            renderSelectedModels();
            
            // Pokazanie/ukrycie przycisku porównania
            toggleCompareButton();
        }

        // Renderowanie wybranych modeli
        function renderSelectedModels() {
            elements.selectedModelsContainer.innerHTML = '';
            
            if (state.selectedModels.length === 0) {
                const noModels = document.createElement('div');
                noModels.className = 'text-sm text-gray-500 dark:text-gray-400 italic';
                noModels.textContent = 'Brak wybranych modeli. Wybierz modele z paska bocznego.';
                elements.selectedModelsContainer.appendChild(noModels);
                return;
            }
            
            state.selectedModels.forEach(modelId => {
                const model = state.models.find(m => m.id === modelId);
                if (!model) return;
                
                const modelElement = document.createElement('div');
                modelElement.className = 'flex items-center px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm';
                modelElement.innerHTML = `
                    <span class="font-medium text-gray-800 dark:text-white mr-2">${model.name}</span>
                    <button class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-model-id="${model.id}">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                
                const removeButton = modelElement.querySelector('button');
                removeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleModelSelection(model.id);
                });
                
                elements.selectedModelsContainer.appendChild(modelElement);
            });
        }

        // Przełączanie widoczności przycisku porównania
        function toggleCompareButton() {
            if (state.selectedModels.length > 1) {
                elements.compareButton.classList.remove('hidden');
            } else {
                elements.compareButton.classList.add('hidden');
            }
        }

        // Obsługa klawiszy w polu wiadomości
        function handleMessageInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleMessageSubmit(e);
            }
        }

        // Obsługa wysyłania wiadomości
        async function handleMessageSubmit(e) {
            e.preventDefault();
            
            const message = elements.messageInput.value.trim();
            if (!message || state.selectedModels.length === 0) return;
            
            // Dodanie wiadomości użytkownika do czatu
            addMessageToChat('user', message, state.currentChatId);
            
            // Wyczyszczenie pola wprowadzania
            elements.messageInput.value = '';
            updateCharacterCount();
            
            // Pokazanie nakładki ładowania
            elements.loadingOverlay.classList.remove('hidden');
            
            try {
                // Wysłanie wiadomości do każdego wybranego modelu
                const responses = await Promise.all(
                    state.selectedModels.map(modelId => sendToOpenRouter(modelId, message))
                );
                
                // Dodanie odpowiedzi do czatu
                responses.forEach((response, index) => {
                    if (response && response.message) {
                        addMessageToChat('assistant', response.message, state.currentChatId, state.selectedModels[index]);
                    }
                });
                
                // Pokazanie przycisku porównania jeśli jest wiele odpowiedzi
                if (responses.length > 1) {
                    elements.compareButton.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Błąd:', error);
                addMessageToChat('assistant', 'Przepraszam, wystąpił błąd podczas przetwarzania Twojego zapytania.', state.currentChatId);
            } finally {
                // Ukrycie nakładki ładowania
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        // Wysyłanie wiadomości do API OpenRouter
        async function sendToOpenRouter(modelId, message) {
            if (!state.apiKey) {
                throw new Error('Klucz API nie jest ustawiony');
            }
            
            // Przygotowanie historii wiadomości dla kontekstu
            const chatContext = [];
            
            // Dodaj wcześniejsze wiadomości z obecnego czatu (maksymalnie 10)
            if (state.chatHistory[state.currentChatId]) {
                const messages = state.chatHistory[state.currentChatId];
                const recentMessages = messages.slice(-20); // Weź maksymalnie 20 ostatnich wiadomości
                
                recentMessages.forEach(msg => {
                    if (msg.role === 'user' || (msg.role === 'assistant' && msg.modelId === modelId)) {
                        chatContext.push({
                            role: msg.role,
                            content: msg.content
                        });
                    }
                });
            }
            
            // Dodaj bieżącą wiadomość
            chatContext.push({
                role: 'user',
                content: message
            });
            
            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Chat SS'
                    },
                    body: JSON.stringify({
                        model: modelId,
                        messages: chatContext,
                        stream: false, // Wyłącz streaming dla uproszczenia
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Błąd API: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                return {
                    modelId,
                    message: data.choices[0].message.content
                };
            } catch (error) {
                console.error(`Błąd wysyłania do modelu ${modelId}:`, error);
                return {
                    modelId,
                    message: `Błąd: ${error.message}`
                };
            }
        }

        // Dodanie wiadomości do czatu
        function addMessageToChat(role, content, chatId, modelId = null) {
            if (!state.chatHistory[chatId]) {
                state.chatHistory[chatId] = [];
            }
            
            const message = {
                id: Date.now().toString(),
                role,
                content,
                timestamp: new Date().toISOString(),
                modelId
            };
            
            state.chatHistory[chatId].push(message);
            saveChatHistory();
            
            // Renderowanie wiadomości
            renderMessage(message);
            
            // Przewinięcie na dół
            setTimeout(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }, 100);
        }

        // Renderowanie wiadomości w czacie
        function renderMessage(message) {
            const isUser = message.role === 'user';
            const model = message.modelId ? state.models.find(m => m.id === message.modelId) : null;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-animation flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            messageElement.innerHTML = `
                <div class="flex max-w-3xl ${isUser ? 'flex-row-reverse' : ''}">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center ${isUser ? 'bg-primary-500 text-white ml-3' : 'bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white mr-3'}">
                        ${isUser ? '<i class="fas fa-user"></i>' : (model ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-question"></i>')}
                    </div>
                    <div class="${isUser ? 'bg-primary-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white'} px-4 py-2 rounded-lg">
                        ${!isUser && model ? `<div class="text-xs font-medium mb-1 ${isUser ? 'text-primary-100' : 'text-gray-500 dark:text-gray-400'}">${model.name}</div>` : ''}
                        <div class="whitespace-pre-wrap">${escapeHtml(message.content)}</div>
                        <div class="text-xs mt-1 ${isUser ? 'text-primary-300' : 'text-gray-500 dark:text-gray-400'}">${formatTime(message.timestamp)}</div>
                    </div>
                </div>
            `;
            
            elements.chatMessages.appendChild(messageElement);
        }

        // Tworzenie nowego czatu
        function createNewChat() {
            const chatId = `chat_${Date.now()}`;
            state.currentChatId = chatId;
            state.chatHistory[chatId] = [];
            saveChatHistory();
            localStorage.setItem('currentChatId', chatId);
            
            // Wyczyszczenie wiadomości czatu
            elements.chatMessages.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <i class="fas fa-comments text-4xl mb-2"></i>
                    <p>Rozpocznij rozmowę z wybranymi modelami AI</p>
                </div>
            `;
        }

        // Wczytanie czatu z historii
        function loadChat(chatId) {
            if (!state.chatHistory[chatId]) return;
            
            state.currentChatId = chatId;
            localStorage.setItem('currentChatId', chatId);
            
            // Wyczyszczenie wiadomości czatu
            elements.chatMessages.innerHTML = '';
            
            // Renderowanie wszystkich wiadomości
            state.chatHistory[chatId].forEach(message => {
                renderMessage(message);
            });
            
            // Przewijanie na dół jeśli są wiadomości
            if (state.chatHistory[chatId].length > 0) {
                setTimeout(() => {
                    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
                }, 100);
            }
        }

        // Wyczyszczenie aktualnego czatu
        function clearCurrentChat() {
            if (!state.currentChatId) return;
            
            if (confirm('Czy na pewno chcesz wyczyścić ten czat?')) {
                state.chatHistory[state.currentChatId] = [];
                saveChatHistory();
                
                // Wyczyszczenie wiadomości czatu
                elements.chatMessages.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <i class="fas fa-comments text-4xl mb-2"></i>
                        <p>Rozpocznij rozmowę z wybranymi modelami AI</p>
                    </div>
                `;
            }
        }

        // Zapisanie historii czatu do localStorage
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(state.chatHistory));
        }

        // Aktualizacja licznika znaków
        function updateCharacterCount() {
            const count = elements.messageInput.value.length;
            elements.characterCount.textContent = count;
            
            if (count > 1000) {
                elements.characterCount.classList.add('text-red-500');
            } else {
                elements.characterCount.classList.remove('text-red-500');
            }
        }

        // Przełączanie widoczności klucza API
        function toggleApiKeyVisibility() {
            const isPassword = elements.apiKeyInput.type === 'password';
            elements.apiKeyInput.type = isPassword ? 'text' : 'password';
            elements.toggleApiKey.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        }

        // Zapisanie klucza API
        function saveApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();
            state.apiKey = apiKey;
            localStorage.setItem('openRouterApiKey', apiKey);
            
            // Ponowne pobranie modeli
            fetchModels();
            
            // Pokazanie komunikatu sukcesu
            showToast('Klucz API zapisany pomyślnie');
        }

        // Weryfikacja klucza API
        async function validateApiKey() {
            const apiKey = elements.apiKeyInput.value.trim();
            
            if (!apiKey) {
                showToast('Proszę najpierw wprowadzić klucz API', 'error');
                return;
            }
            
            try {
                elements.loadingOverlay.classList.remove('hidden');
                
                const response = await fetch('https://openrouter.ai/api/v1/auth/key', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Weryfikacja klucza API nie powiodła się (status ${response.status})`);
                }
                
                const data = await response.json();
                showToast(`Klucz API jest ważny. Pozostałe kredyty: ${data.data.limit_remaining || 'Nieznane'}`, 'success');
            } catch (error) {
                console.error('Błąd weryfikacji klucza API:', error);
                showToast(`Błąd: ${error.message}`, 'error');
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        }

        // Zastosowanie motywu
        function applyTheme(theme) {
            state.theme = theme;
            localStorage.setItem('theme', theme);
            
            // Aktualizacja przycisków motywu
            elements.lightTheme.classList.remove('bg-primary-500', 'text-white');
            elements.darkTheme.classList.remove('bg-primary-500', 'text-white');
            elements.systemTheme.classList.remove('bg-primary-500', 'text-white');
            
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                elements.lightTheme.classList.add('bg-primary-500', 'text-white');
            } else if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                elements.darkTheme.classList.add('bg-primary-500', 'text-white');
            } else {
                // Motyw systemowy - sprawdź prefers-color-scheme
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                elements.systemTheme.classList.add('bg-primary-500', 'text-white');
            }
        }

        // Przełączanie motywu
        function toggleTheme() {
            const themes = ['light', 'dark', 'system'];
            const currentIndex = themes.indexOf(state.theme);
            const nextIndex = (currentIndex + 1) % themes.length;
            applyTheme(themes[nextIndex]);
        }

        // Eksport historii czatu
        function exportChatHistory() {
            if (Object.keys(state.chatHistory).length === 0) {
                showToast('Brak historii czatu do eksportu', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(state.chatHistory, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `chat-ss-${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Historia czatu wyeksportowana pomyślnie');
        }

        // Import historii czatu
        function importChatHistory() {
            const file = elements.chatImportFile.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedHistory = JSON.parse(e.target.result);
                    if (typeof importedHistory !== 'object' || importedHistory === null) {
                        throw new Error('Nieprawidłowy format pliku');
                    }
                    
                    // Połączenie z istniejącą historią
                    state.chatHistory = { ...state.chatHistory, ...importedHistory };
                    saveChatHistory();
                    
                    showToast('Historia czatu zaimportowana pomyślnie');
                    
                    // Jeśli aktualnie wybrany czat nie istnieje, utwórz nowy
                    if (!state.currentChatId || !state.chatHistory[state.currentChatId]) {
                        createNewChat();
                    } else {
                        loadChat(state.currentChatId);
                    }
                } catch (error) {
                    console.error('Błąd importu historii czatu:', error);
                    showToast('Błąd importu historii czatu', 'error');
                }
            };
            reader.readAsText(file);
            
            // Resetowanie pola wejściowego pliku
            elements.chatImportFile.value = '';
        }

        // Pokazanie modalu porównywania
        function showCompareModal() {
            if (!state.currentChatId || state.chatHistory[state.currentChatId].length === 0) {
                showToast('Brak wiadomości do porównania', 'warning');
                return;
            }
            
            // Pobranie ostatniej wiadomości użytkownika i wszystkich odpowiedzi asystenta
            const chat = state.chatHistory[state.currentChatId];
            const lastUserMessage = [...chat].reverse().find(m => m.role === 'user');
            
            if (!lastUserMessage) {
                showToast('Nie znaleziono wiadomości użytkownika do porównania', 'warning');
                return;
            }
            
            const assistantResponses = chat.filter(m => 
                m.role === 'assistant' && 
                m.timestamp > lastUserMessage.timestamp
            );
            
            if (assistantResponses.length < 2) {
                showToast('Potrzeba co najmniej 2 odpowiedzi modeli do porównania', 'warning');
                return;
            }
            
            // Renderowanie porównania
            elements.compareResults.innerHTML = `
                <div class="col-span-1 md:col-span-2">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
                        <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Wiadomość użytkownika</div>
                        <div class="whitespace-pre-wrap bg-white dark:bg-gray-800 p-3 rounded">${escapeHtml(lastUserMessage.content)}</div>
                    </div>
                </div>
            `;
            
            assistantResponses.forEach(response => {
                const model = state.models.find(m => m.id === response.modelId);
                
                const responseElement = document.createElement('div');
                responseElement.className = 'bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                responseElement.innerHTML = `
                    <div class="flex items-center mb-2">
                        <div class="h-6 w-6 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mr-2">
                            <i class="fas fa-robot text-xs"></i>
                        </div>
                        <h4 class="font-medium">${model ? model.name : 'Nieznany model'}</h4>
                    </div>
                    <div class="whitespace-pre-wrap text-gray-800 dark:text-gray-200">${escapeHtml(response.content)}</div>
                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">${formatTime(response.timestamp)}</div>
                `;
                
                elements.compareResults.appendChild(responseElement);
            });
            
            elements.compareModal.classList.remove('hidden');
        }

        // Pokazanie powiadomienia toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-yellow-500'
            } z-50 flex items-center`;
            
            toast.innerHTML = `
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    'fa-exclamation-triangle'
                } mr-2"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Funkcja pomocnicza do ucieczki HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, '<br>');
        }

        // Funkcja pomocnicza do formatowania czasu
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Funkcja pomocnicza do opóźnienia wykonania
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Inicjalizacja aplikacji po załadowaniu DOM
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
